@using MudBlazor
@using SmashScheduler.Domain.Entities
@using SmashScheduler.Domain.Enums
@using SmashScheduler.Web.Components

<MudCard Class="@GetCardClass()" Elevation="2">
    <MudCardHeader Class="pb-0">
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.SportsScore" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Court @Match.CourtNumber</MudText>
                </MudStack>
                @if (Match.State == MatchState.Completed)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">
                        <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-1" />
                        Complete
                    </MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Filled">
                        <span class="status-dot mr-2"></span>
                        Playing
                    </MudChip>
                }
            </MudStack>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudStack Spacing="2">
            <div class="team-section team-1">
                <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-weight: 600;">TEAM 1</MudText>
                @foreach (var player in GetTeam1Players())
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-1">
                        <MudText Typo="Typo.body2">@player.Name</MudText>
                        <SkillLevelBadge SkillLevel="@player.SkillLevel" Size="Size.Small" />
                    </MudStack>
                }
            </div>

            <div class="vs-divider">vs</div>

            <div class="team-section team-2">
                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600;">TEAM 2</MudText>
                @foreach (var player in GetTeam2Players())
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-1">
                        <MudText Typo="Typo.body2">@player.Name</MudText>
                        <SkillLevelBadge SkillLevel="@player.SkillLevel" Size="Size.Small" />
                    </MudStack>
                }
            </div>

            @if (Match.Score != null)
            {
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Primary">
                    @Match.Score.Team1Score - @Match.Score.Team2Score
                </MudText>
            }
        </MudStack>
    </MudCardContent>
    @if (!IsReadOnly && Match.State == MatchState.InProgress)
    {
        <MudCardActions Class="pa-4 pt-0">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.CheckCircle"
                       OnClick="@(() => OnComplete.InvokeAsync(Match.Id))">
                Complete Match
            </MudButton>
        </MudCardActions>
    }
</MudCard>

@code {
    [Parameter, EditorRequired] public Match Match { get; set; } = null!;
    [Parameter] public Dictionary<Guid, Player> PlayerLookup { get; set; } = new();
    [Parameter] public bool IsReadOnly { get; set; }
    [Parameter] public EventCallback<Guid> OnComplete { get; set; }

    private string GetCardClass()
    {
        var baseClass = "match-card";
        return Match.State == MatchState.Completed ? $"{baseClass} match-card--complete" : baseClass;
    }

    private IEnumerable<Player> GetTeam1Players()
    {
        var playerIds = Match.PlayerIds.Take(2);
        return playerIds
            .Where(id => PlayerLookup.ContainsKey(id))
            .Select(id => PlayerLookup[id]);
    }

    private IEnumerable<Player> GetTeam2Players()
    {
        var playerIds = Match.PlayerIds.Skip(2).Take(2);
        return playerIds
            .Where(id => PlayerLookup.ContainsKey(id))
            .Select(id => PlayerLookup[id]);
    }
}
