@using SmashScheduler.Domain.Entities
@using SmashScheduler.Domain.Enums

<MudCard Class="@GetCardClass()" Elevation="2">
    @if (ShowHeader)
    {
        <MudCardHeader Class="pb-0">
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="match-card-header-badges">
                        <MudIcon Icon="@Icons.Material.Filled.SportsScore" Color="Color.Primary" />
                        <MudText Typo="Typo.h6">@GetDisplayCourtLabel()</MudText>
                        @if (!Match.WasAutomated)
                        {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Outlined" Class="manual-badge">
                                Manual
                            </MudChip>
                        }
                    </MudStack>
                    @if (Match.State == MatchState.Completed)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">
                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-1" />
                            Complete
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Filled">
                            <span class="status-dot mr-2"></span>
                            Playing
                        </MudChip>
                    }
                </MudStack>
            </CardHeaderContent>
        </MudCardHeader>
    }
    <MudCardContent>
        <MudStack Spacing="2">
            <div class="@GetTeamSectionClass("team-1", 1)" @onclick="() => CompleteWithTeam(1)">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-weight: 600;">TEAM 1</MudText>
                    @if (IsWinningTeam(1))
                    {
                        <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Size="Size.Small" />
                    }
                </MudStack>
                @foreach (var player in GetTeam1Players())
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-1">
                        <GenderStyledPlayerAvatar Player="player" Size="Size.Small"/>
                        <MudText Typo="Typo.body2">@player.Name</MudText>
                        <SkillLevelBadge SkillLevel="@player.SkillLevel" Size="Size.Small"/>
                    </MudStack>
                }
            </div>

            <div class="vs-divider">vs</div>

            <div class="@GetTeamSectionClass("team-2", 2)" @onclick="() => CompleteWithTeam(2)">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600;">TEAM 2</MudText>
                    @if (IsWinningTeam(2))
                    {
                        <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Size="Size.Small" />
                    }
                </MudStack>
                @foreach (var player in GetTeam2Players())
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-1">
                        <GenderStyledPlayerAvatar Player="player" Size="Size.Small"/>
                        <MudText Typo="Typo.body2">@player.Name</MudText>
                        <SkillLevelBadge SkillLevel="@player.SkillLevel" Size="Size.Small"/>
                    </MudStack>
                }
            </div>

            @if (Match.Score != null)
            {
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Primary">
                    @Match.Score.Team1Score - @Match.Score.Team2Score
                </MudText>
            }

            @if (Match.State == MatchState.Completed && Match.CompletedAt.HasValue)
            {
                <MudDivider Class="my-2" />
                <div class="match-timing">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Started: @Match.StartedAt.ToLocalTime().ToString("HH:mm")
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Ended: @Match.CompletedAt.Value.ToLocalTime().ToString("HH:mm")
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Duration: @FormatDuration(Match.CompletedAt.Value - Match.StartedAt)
                    </MudText>
                </div>
            }
        </MudStack>
    </MudCardContent>
    @if (!IsReadOnly && Match.State == MatchState.InProgress)
    {
        <MudCardActions Class="pa-4 pt-0">
            <MudStack Row="true" Spacing="2" Style="width: 100%;" Class="match-card-actions">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.CheckCircle"
                           OnClick="@(() => OnComplete.InvokeAsync((Match.Id, (int?)null)))">
                    Complete Match
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Edit"
                           OnClick="@(() => OnEdit.InvokeAsync(Match.Id))">
                    Edit Players
                </MudButton>
            </MudStack>
        </MudCardActions>
    }
</MudCard>

@code {
    [Parameter, EditorRequired] public Match Match { get; set; } = null!;
    [Parameter] public Dictionary<Guid, Player> PlayerLookup { get; set; } = new();
    [Parameter] public string? CourtLabel { get; set; }
    [Parameter] public bool IsReadOnly { get; set; }
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public EventCallback<(Guid MatchId, int? PreSelectedWinner)> OnComplete { get; set; }
    [Parameter] public EventCallback<Guid> OnEdit { get; set; }

    private string GetDisplayCourtLabel() =>
        !string.IsNullOrWhiteSpace(CourtLabel) ? CourtLabel : $"Court {Match.CourtNumber}";

    private string GetCardClass()
    {
        var baseClass = "match-card";
        return Match.State == MatchState.Completed ? $"{baseClass} match-card--complete" : baseClass;
    }

    private string GetTeamSectionClass(string teamClass, int teamNumber)
    {
        var baseClass = $"team-section {teamClass}";
        if (IsWinningTeam(teamNumber))
            baseClass = $"{baseClass} team-section--winner";
        return !IsReadOnly && Match.State == MatchState.InProgress
            ? $"{baseClass} team-section--clickable"
            : baseClass;
    }

    private bool IsWinningTeam(int teamNumber)
    {
        if (Match.State != MatchState.Completed || Match.WinningPlayerIds.Count == 0)
            return false;

        var teamPlayerIds = teamNumber == 1
            ? Match.PlayerIds.Take(2).ToHashSet()
            : Match.PlayerIds.Skip(2).Take(2).ToHashSet();

        return teamPlayerIds.SetEquals(Match.WinningPlayerIds.ToHashSet());
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        return $"{duration.Minutes}m";
    }

    private async Task CompleteWithTeam(int teamNumber)
    {
        if (IsReadOnly || Match.State != MatchState.InProgress) return;
        await OnComplete.InvokeAsync((Match.Id, teamNumber));
    }

    private IEnumerable<Player> GetTeam1Players()
    {
        var playerIds = Match.PlayerIds.Take(2);
        return playerIds
            .Where(id => PlayerLookup.ContainsKey(id))
            .Select(id => PlayerLookup[id]);
    }

    private IEnumerable<Player> GetTeam2Players()
    {
        var playerIds = Match.PlayerIds.Skip(2).Take(2);
        return playerIds
            .Where(id => PlayerLookup.ContainsKey(id))
            .Select(id => PlayerLookup[id]);
    }
}
