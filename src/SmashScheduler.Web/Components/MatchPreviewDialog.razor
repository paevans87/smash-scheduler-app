@using SmashScheduler.Application.Services.Matchmaking
@using SmashScheduler.Application.Services.Matchmaking.Models
@using SmashScheduler.Domain.Entities
@inject IMatchmakingService MatchmakingService

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Preview" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Confirm Matches</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Review the proposed matches. Remove players and re-generate if needed.
            </MudText>

            @if (_excludedPlayerIds.Any())
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Style="flex-wrap: wrap;">
                        <MudText Typo="Typo.body2">Excluded:</MudText>
                        @foreach (var playerId in _excludedPlayerIds)
                        {
                            @if (PlayerLookup.TryGetValue(playerId, out var player))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled"
                                         OnClose="() => RestorePlayer(playerId)">
                                    @player.Name
                                </MudChip>
                            }
                        }
                    </MudStack>
                </MudAlert>
            }

            @foreach (var candidate in _currentMatches)
            {
                <MudPaper Class="pa-3" Elevation="2">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                Court @candidate.CourtNumber
                            </MudText>
                            @if (candidate.TotalScore > 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="@GetScoreColour(candidate.TotalScore)" Variant="Variant.Outlined">
                                    Score: @candidate.TotalScore.ToString("F0")
                                </MudChip>
                            }
                        </MudStack>

                        <MudGrid Spacing="2">
                            <MudItem xs="5">
                                <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-weight: 600;">TEAM 1</MudText>
                                @foreach (var playerId in candidate.PlayerIds.Take(2))
                                {
                                    @if (PlayerLookup.TryGetValue(playerId, out var player))
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mt-1">
                                            <MudText Typo="Typo.body2">@player.Name</MudText>
                                            <SkillLevelBadge SkillLevel="@player.SkillLevel" Size="Size.Small" />
                                            <MudIconButton Icon="@Icons.Material.Filled.PersonRemove"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="() => ExcludePlayer(playerId)" />
                                        </MudStack>
                                    }
                                }
                            </MudItem>
                            <MudItem xs="2" Style="display: flex; align-items: center; justify-content: center;">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">vs</MudText>
                            </MudItem>
                            <MudItem xs="5">
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600;">TEAM 2</MudText>
                                @foreach (var playerId in candidate.PlayerIds.Skip(2).Take(2))
                                {
                                    @if (PlayerLookup.TryGetValue(playerId, out var player))
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mt-1">
                                            <MudText Typo="Typo.body2">@player.Name</MudText>
                                            <SkillLevelBadge SkillLevel="@player.SkillLevel" Size="Size.Small" />
                                            <MudIconButton Icon="@Icons.Material.Filled.PersonRemove"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="() => ExcludePlayer(playerId)" />
                                        </MudStack>
                                    }
                                }
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudPaper>
            }

            @if (!_currentMatches.Any())
            {
                <MudAlert Severity="Severity.Info">
                    No matches could be generated. Check that there are enough players on the bench.
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        @if (_excludedPlayerIds.Any())
        {
            <MudButton OnClick="Regenerate"
                       Color="Color.Secondary"
                       Variant="Variant.Outlined"
                       Disabled="@_isRegenerating">
                @if (_isRegenerating)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Re-generate
            </MudButton>
        }
        <MudButton OnClick="Submit"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="@(!_currentMatches.Any())">
            Create @_currentMatches.Count Match@(_currentMatches.Count != 1 ? "es" : "")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public List<MatchCandidate> ProposedMatches { get; set; } = new();
    [Parameter] public Dictionary<Guid, Player> PlayerLookup { get; set; } = new();
    [Parameter] public Guid SessionId { get; set; }

    private List<MatchCandidate> _currentMatches = new();
    private List<Guid> _excludedPlayerIds = new();
    private bool _isRegenerating;

    protected override void OnInitialized()
    {
        _currentMatches = new List<MatchCandidate>(ProposedMatches);
    }

    private void ExcludePlayer(Guid playerId)
    {
        if (!_excludedPlayerIds.Contains(playerId))
        {
            _excludedPlayerIds.Add(playerId);
        }
    }

    private void RestorePlayer(Guid playerId)
    {
        _excludedPlayerIds.Remove(playerId);
    }

    private async Task Regenerate()
    {
        _isRegenerating = true;
        StateHasChanged();

        var candidates = await MatchmakingService.GenerateMatchesAsync(SessionId, _excludedPlayerIds);
        _currentMatches = candidates;

        _isRegenerating = false;
        StateHasChanged();
    }

    private Color GetScoreColour(double score) => score switch
    {
        >= 80 => Color.Success,
        >= 60 => Color.Warning,
        _ => Color.Error
    };

    private void Cancel() => MudDialog.Cancel();

    private void Submit() => MudDialog.Close(DialogResult.Ok(new MatchPreviewResult(_currentMatches, false)));
}
