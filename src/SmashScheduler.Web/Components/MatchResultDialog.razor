@using SmashScheduler.Domain.Entities
@using SmashScheduler.Domain.ValueObjects

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Complete Match - Court @Match.CourtNumber</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                Click a team to select the winner, or enter scores
            </MudText>

            <MudGrid Spacing="4" Justify="Justify.Center">
                <MudItem xs="5">
                    <MudPaper Class="@GetTeamCardClass(1)"
                              Elevation="@GetTeamElevation(1)"
                              @onclick="() => SelectWinner(1)">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.caption" Color="@GetTeamLabelColour(1)" Style="font-weight: 600;">TEAM 1</MudText>
                            @if (_selectedWinner == 1)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Size="Size.Small" />
                            }
                        </MudStack>
                        @foreach (var player in GetTeam1Players())
                        {
                            <MudText Typo="Typo.body2" Class="mt-1">@player.Name</MudText>
                        }
                        <MudNumericField T="int?"
                                         Value="_team1Score"
                                         ValueChanged="OnTeam1ScoreChanged"
                                         Label="Score"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Class="mt-3"
                                         Immediate="true"
                                         @onclick:stopPropagation="true" />
                    </MudPaper>
                </MudItem>
                <MudItem xs="2" Class="d-flex align-center justify-center">
                    <MudText Typo="Typo.h5" Color="Color.Secondary">vs</MudText>
                </MudItem>
                <MudItem xs="5">
                    <MudPaper Class="@GetTeamCardClass(2)"
                              Elevation="@GetTeamElevation(2)"
                              @onclick="() => SelectWinner(2)">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.caption" Color="@GetTeamLabelColour(2)" Style="font-weight: 600;">TEAM 2</MudText>
                            @if (_selectedWinner == 2)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Size="Size.Small" />
                            }
                        </MudStack>
                        @foreach (var player in GetTeam2Players())
                        {
                            <MudText Typo="Typo.body2" Class="mt-1">@player.Name</MudText>
                        }
                        <MudNumericField T="int?"
                                         Value="_team2Score"
                                         ValueChanged="OnTeam2ScoreChanged"
                                         Label="Score"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Class="mt-3"
                                         Immediate="true"
                                         @onclick:stopPropagation="true" />
                    </MudPaper>
                </MudItem>
            </MudGrid>

            @if (_selectedWinner.HasValue)
            {
                <MudAlert Severity="Severity.Success" Dense="true" Icon="@Icons.Material.Filled.EmojiEvents">
                    Winner: @GetWinnerDescription()
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="SkipResult" Variant="Variant.Outlined" Color="Color.Default">Skip Result</MudButton>
        <MudButton OnClick="Submit"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="@(!CanSubmit)">
            Complete
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter, EditorRequired] public Match Match { get; set; } = null!;
    [Parameter] public Dictionary<Guid, Player> PlayerLookup { get; set; } = new();
    [Parameter] public int? PreSelectedWinner { get; set; }

    private int? _team1Score;
    private int? _team2Score;
    private int? _selectedWinner;

    protected override void OnInitialized()
    {
        if (PreSelectedWinner is 1 or 2)
        {
            _selectedWinner = PreSelectedWinner;
        }
    }

    private bool HasValidScores => _team1Score.HasValue && _team2Score.HasValue;
    private bool CanSubmit => _selectedWinner.HasValue || HasValidScores;

    private IEnumerable<Player> GetTeam1Players()
    {
        return Match.PlayerIds.Take(2)
            .Where(id => PlayerLookup.ContainsKey(id))
            .Select(id => PlayerLookup[id]);
    }

    private IEnumerable<Player> GetTeam2Players()
    {
        return Match.PlayerIds.Skip(2).Take(2)
            .Where(id => PlayerLookup.ContainsKey(id))
            .Select(id => PlayerLookup[id]);
    }

    private void SelectWinner(int team)
    {
        _selectedWinner = _selectedWinner == team ? null : team;
    }

    private void OnTeam1ScoreChanged(int? value)
    {
        _team1Score = value;
        UpdateWinnerFromScores();
    }

    private void OnTeam2ScoreChanged(int? value)
    {
        _team2Score = value;
        UpdateWinnerFromScores();
    }

    private void UpdateWinnerFromScores()
    {
        if (!HasValidScores) return;

        if (_team1Score > _team2Score)
            _selectedWinner = 1;
        else if (_team2Score > _team1Score)
            _selectedWinner = 2;
        else
            _selectedWinner = null;
    }

    private string GetTeamCardClass(int team)
    {
        var teamColour = team == 1 ? "team-1" : "team-2";
        var selected = _selectedWinner == team ? " team-card--selected" : "";
        return $"pa-3 team-card {teamColour}{selected}";
    }

    private int GetTeamElevation(int team)
    {
        return _selectedWinner == team ? 4 : 0;
    }

    private Color GetTeamLabelColour(int team)
    {
        return team == 1 ? Color.Primary : Color.Secondary;
    }

    private string GetWinnerDescription()
    {
        if (!_selectedWinner.HasValue) return string.Empty;

        var winningTeam = _selectedWinner == 1 ? GetTeam1Players() : GetTeam2Players();
        return string.Join(" & ", winningTeam.Select(p => p.Name));
    }

    private List<Guid> GetWinningPlayerIds()
    {
        if (!_selectedWinner.HasValue) return new List<Guid>();

        return _selectedWinner == 1
            ? Match.PlayerIds.Take(2).ToList()
            : Match.PlayerIds.Skip(2).Take(2).ToList();
    }

    private void Cancel() => MudDialog.Cancel();

    private void SkipResult()
    {
        MudDialog.Close(DialogResult.Ok<(MatchScore?, List<Guid>?)>((null, null)));
    }

    private void Submit()
    {
        if (!CanSubmit) return;

        MatchScore? score = HasValidScores
            ? new MatchScore(_team1Score!.Value, _team2Score!.Value)
            : null;

        var winners = GetWinningPlayerIds();

        MudDialog.Close(DialogResult.Ok<(MatchScore?, List<Guid>?)>((score, winners.Count > 0 ? winners : null)));
    }
}
