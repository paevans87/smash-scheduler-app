@using SmashScheduler.Domain.Entities
@using SmashScheduler.Domain.Enums
@inject IDialogService DialogService

<MudStack Spacing="4">
    <CourtDisplay Matches="@ActiveMatches"
                  CourtCount="@Session.CourtCount"
                  CourtLabels="@Session.CourtLabels"
                  PlayerLookup="@PlayerLookup"
                  IsReadOnly="false"
                  OnMatchComplete="@OnMatchComplete"
                  OnMatchEdit="@HandleEditMatch" />

    @if (GetDraftMatches().Any())
    {
        <MudPaper Class="pa-4" Elevation="2" Style="border-radius: var(--radius-lg);">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Drafts" Color="Color.Info" />
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Draft Matches</MudText>
                    <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Filled">
                        @GetDraftMatches().Count queued
                    </MudChip>
                </MudStack>
                @foreach (var draft in GetDraftMatches())
                {
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudStack Spacing="2">
                            <MudGrid Spacing="2">
                                <MudItem xs="12" sm="5">
                                    <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-weight: 600;">TEAM 1</MudText>
                                    @foreach (var playerId in draft.PlayerIds.Take(2))
                                    {
                                        @if (PlayerLookup.TryGetValue(playerId, out var player))
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-1">
                                                <MudText Typo="Typo.body2">@player.Name</MudText>
                                                <SkillLevelBadge SkillLevel="@player.SkillLevel" Size="Size.Small" />
                                            </MudStack>
                                        }
                                    }
                                </MudItem>
                                <MudItem xs="12" sm="2" Style="display: flex; align-items: center; justify-content: center;">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">vs</MudText>
                                </MudItem>
                                <MudItem xs="12" sm="5">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600;">TEAM 2</MudText>
                                    @foreach (var playerId in draft.PlayerIds.Skip(2).Take(2))
                                    {
                                        @if (PlayerLookup.TryGetValue(playerId, out var player))
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-1">
                                                <MudText Typo="Typo.body2">@player.Name</MudText>
                                                <SkillLevelBadge SkillLevel="@player.SkillLevel" Size="Size.Small" />
                                            </MudStack>
                                        }
                                    }
                                </MudItem>
                            </MudGrid>
                            <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Delete"
                                           OnClick="() => OnDeleteDraftMatch.InvokeAsync(draft.Id)">
                                    Remove
                                </MudButton>
                                @if (GetAvailableCourts().Any())
                                {
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.PlayArrow"
                                               OnClick="() => HandleStartDraft(draft.Id)">
                                        Start on Court
                                    </MudButton>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">
                                        No courts available
                                    </MudChip>
                                }
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>
        </MudPaper>
    }

    <BenchDisplay BenchedPlayers="@GetBenchedPlayers()" GamesPlayedLookup="@GamesPlayedLookup" />
</MudStack>

@if (CanGenerateMatches)
{
    <MudFab Class="@($"{GetFabClass()} smash-fab-fixed")"
            StartIcon="@(IsGenerating ? Icons.Material.Filled.Sync : Icons.Material.Filled.AutoAwesome)"
            Label="@(IsGenerating ? "Generating..." : "Generate Matches")"
            OnClick="HandleGenerateMatches"
            Disabled="@IsGenerating"
            Size="Size.Large" />
}

@code {
    [Parameter, EditorRequired] public Session Session { get; set; } = null!;
    [Parameter] public List<Match> ActiveMatches { get; set; } = new();
    [Parameter] public Dictionary<Guid, Player> PlayerLookup { get; set; } = new();
    [Parameter] public EventCallback OnGenerateMatches { get; set; }
    [Parameter] public EventCallback<(Guid MatchId, int? PreSelectedWinner)> OnMatchComplete { get; set; }
    [Parameter] public EventCallback<(Guid MatchId, List<Guid> PlayerIds)> OnMatchPlayersUpdate { get; set; }
    [Parameter] public EventCallback<(Guid MatchId, int CourtNumber)> OnStartDraftMatch { get; set; }
    [Parameter] public EventCallback<Guid> OnDeleteDraftMatch { get; set; }
    [Parameter] public bool CanGenerateMatches { get; set; }
    [Parameter] public Dictionary<Guid, int> GamesPlayedLookup { get; set; } = new();

    private bool IsGenerating { get; set; }

    private string GetFabClass()
    {
        return IsGenerating ? "smash-fab smash-fab--loading" : "smash-fab";
    }

    private List<Match> GetDraftMatches()
    {
        return ActiveMatches.Where(m => m.State == MatchState.Draft).ToList();
    }

    private List<int> GetAvailableCourts()
    {
        var usedCourts = ActiveMatches
            .Where(m => m.State == MatchState.InProgress)
            .Select(m => m.CourtNumber)
            .ToHashSet();

        return Enumerable.Range(1, Session.CourtCount)
            .Where(c => !usedCourts.Contains(c))
            .ToList();
    }

    private IEnumerable<Player> GetBenchedPlayers()
    {
        var committedPlayerIds = ActiveMatches
            .Where(m => m.State != MatchState.Completed)
            .SelectMany(m => m.PlayerIds)
            .ToHashSet();

        return Session.SessionPlayers
            .Where(sp => sp.IsActive)
            .Select(sp => sp.PlayerId)
            .Where(id => !committedPlayerIds.Contains(id) && PlayerLookup.ContainsKey(id))
            .Select(id => PlayerLookup[id]);
    }

    private async Task HandleGenerateMatches()
    {
        IsGenerating = true;
        StateHasChanged();

        await OnGenerateMatches.InvokeAsync();

        IsGenerating = false;
        StateHasChanged();
    }

    private async Task HandleStartDraft(Guid matchId)
    {
        var availableCourts = GetAvailableCourts();
        if (!availableCourts.Any()) return;

        if (availableCourts.Count == 1)
        {
            await OnStartDraftMatch.InvokeAsync((matchId, availableCourts.First()));
            return;
        }

        var parameters = new DialogParameters<CourtSelectionDialog>
        {
            { x => x.AvailableCourts, availableCourts },
            { x => x.CourtLabels, Session.CourtLabels }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraSmall,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<CourtSelectionDialog>("Select Court", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: int selectedCourt })
        {
            await OnStartDraftMatch.InvokeAsync((matchId, selectedCourt));
        }
    }

    private async Task HandleEditMatch(Guid matchId)
    {
        var match = ActiveMatches.FirstOrDefault(m => m.Id == matchId);
        if (match == null) return;

        var playersInOtherMatches = ActiveMatches
            .Where(m => m.Id != matchId && m.State == MatchState.InProgress)
            .SelectMany(m => m.PlayerIds)
            .ToHashSet();

        var benchPlayerIds = GetBenchedPlayers().Select(p => p.Id).ToList();

        var parameters = new DialogParameters<MatchEditorDialog>
        {
            { x => x.Match, match },
            { x => x.PlayerLookup, PlayerLookup },
            { x => x.BenchPlayerIds, benchPlayerIds },
            { x => x.PlayersInOtherMatches, playersInOtherMatches }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<MatchEditorDialog>("Edit Match Players", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: List<Guid> newPlayerIds })
        {
            await OnMatchPlayersUpdate.InvokeAsync((matchId, newPlayerIds));
            StateHasChanged();
        }
    }
}
