@inject IBreadcrumbService BreadcrumbService
@inject IThemeService ThemeService
@inject IDialogService DialogService
@using SmashScheduler.Web.Services
@using SmashScheduler.Web.Themes
@implements IAsyncDisposable
@inherits LayoutComponentBase

<MudThemeProvider @ref="_mudThemeProvider" Theme="SmashSchedulerTheme.Theme" IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider/>
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Class="smash-app-bar">
        <MudLink Href="/">
            <MudAvatar>
                <MudImage Src="images/icon-192.png" Alt="Smash Scheduler" />
            </MudAvatar>
        </MudLink>
        <MudLink Href="/" Underline="Underline.None" Color="Color.Inherit">
            <MudText Typo="Typo.h6" Class="ml-2">SmashScheduler</MudText>
        </MudLink>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Settings"
                       Color="Color.Inherit"
                       OnClick="@OpenSettings" />
    </MudAppBar>
    <MudMainContent Class="smash-main-content">
        <MudContainer MaxWidth="MaxWidth.Large">
            @if (_items.Any())
            {
                <MudBreadcrumbs Items="_items" />
            }
            
        </MudContainer>
        <MudContainer MaxWidth="MaxWidth.Large">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private List<BreadcrumbItem> _items = new();
    private MudThemeProvider _mudThemeProvider = null!;
    private bool _isDarkMode;

    protected override void OnInitialized()
    {
        _items = BreadcrumbService.Items;
        _isDarkMode = ThemeService.IsDarkMode;

        BreadcrumbService.OnChange += HandleBreadcrumbsChanged;
        ThemeService.OnChange += HandleThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var systemPreference = await _mudThemeProvider.GetSystemDarkModeAsync();
            ThemeService.SetSystemPreference(systemPreference);
            _isDarkMode = ThemeService.IsDarkMode;
            StateHasChanged();

            await _mudThemeProvider.WatchSystemDarkModeAsync(OnSystemPreferenceChanged);
        }
    }

    private Task OnSystemPreferenceChanged(bool prefersDark)
    {
        ThemeService.SetSystemPreference(prefersDark);
        return Task.CompletedTask;
    }

    private void HandleBreadcrumbsChanged()
    {
        InvokeAsync(() =>
        {
            _items = BreadcrumbService.Items;
            StateHasChanged();
        });
    }

    private void HandleThemeChanged()
    {
        InvokeAsync(() =>
        {
            _isDarkMode = ThemeService.IsDarkMode;
            StateHasChanged();
        });
    }

    private async Task OpenSettings()
    {
        var parameters = new DialogParameters<SettingsDialog>
        {
            { x => x.DialogService, DialogService }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraSmall,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<SettingsDialog>("Settings", parameters, options);
    }

    public async ValueTask DisposeAsync()
    {
        BreadcrumbService.OnChange -= HandleBreadcrumbsChanged;
        ThemeService.OnChange -= HandleThemeChanged;
    }
}