@page "/clubs/{ClubId:guid}"
@using MudBlazor
@using SmashScheduler.Application.Services.ClubManagement
@using SmashScheduler.Application.Services.SessionManagement
@using SmashScheduler.Domain.Entities
@using SmashScheduler.Domain.Enums
@using SmashScheduler.Web.Components
@inject IClubService ClubService
@inject ISessionService SessionService
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>Club Details</PageTitle>

@if (_club == null)
{
    <MudStack AlignItems="AlignItems.Center" Class="py-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </MudStack>
}
else
{
    <MudStack Spacing="4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                               Color="Color.Default"
                               OnClick="GoBack" />
                <MudStack>
                    <MudText Typo="Typo.h4" Style="font-weight: 700;">@_club.Name</MudText>
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary">
                            @_club.DefaultCourtCount courts
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Secondary">
                            @_club.GameType
                        </MudChip>
                    </MudStack>
                </MudStack>
            </MudStack>
            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                           Color="Color.Primary"
                           Variant="Variant.Filled"
                           Size="Size.Medium"
                           OnClick="OpenEditDialog" />
        </MudStack>

        <MudGrid Spacing="3">
            <MudItem xs="12" sm="6">
                <MudCard Class="smash-card smash-card-clickable" Elevation="2" @onclick="ViewPlayers">
                    <MudCardContent>
                        <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                            <MudAvatar Size="Size.Large" Color="Color.Primary" Variant="Variant.Filled">
                                <MudIcon Icon="@Icons.Material.Filled.Groups" />
                            </MudAvatar>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">Players</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Manage club members</MudText>
                            </MudStack>
                            <MudSpacer />
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Secondary" />
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudCard Class="smash-card smash-card-clickable" Elevation="2" @onclick="ViewSessions">
                    <MudCardContent>
                        <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                            <MudAvatar Size="Size.Large" Color="Color.Secondary" Variant="Variant.Filled">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" />
                            </MudAvatar>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">Sessions</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">View and create sessions</MudText>
                            </MudStack>
                            <MudSpacer />
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Secondary" />
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <MudPaper Class="pa-4" Elevation="1" Style="border-radius: var(--radius-lg);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Session History</MudText>
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="ViewSessions">
                    View All
                </MudButton>
            </MudStack>
            @if (_sessions == null)
            {
                <MudProgressLinear Indeterminate="true" />
            }
            else if (!_sessions.Any())
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">No sessions yet</MudText>
            }
            else
            {
                <MudTable Items="@_sessions.OrderByDescending(s => s.ScheduledDateTime).Take(5)"
                          T="Session"
                          Dense="true"
                          Hover="true"
                          Breakpoint="Breakpoint.Sm"
                          RowClass="cursor-pointer"
                          OnRowClick="@NavigateToSession">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>Time</MudTh>
                        <MudTh>Players</MudTh>
                        <MudTh>Status</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Date">@context.ScheduledDateTime.ToString("dd MMM yyyy")</MudTd>
                        <MudTd DataLabel="Time">@context.ScheduledDateTime.ToString("HH:mm")</MudTd>
                        <MudTd DataLabel="Players">@context.SessionPlayers.Count</MudTd>
                        <MudTd DataLabel="Status">
                            <SessionStateBadge State="@context.State" Size="Size.Small" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudPaper>
    </MudStack>
}

@code {
    [Parameter] public Guid ClubId { get; set; }
    private Club? _club;
    private List<Session>? _sessions;

    protected override async Task OnInitializedAsync()
    {
        _club = await ClubService.GetByIdAsync(ClubId);
        _sessions = await SessionService.GetByClubIdAsync(ClubId);
    }

    private void ViewPlayers()
    {
        Navigation.NavigateTo($"/clubs/{ClubId}/players");
    }

    private void ViewSessions()
    {
        Navigation.NavigateTo($"/clubs/{ClubId}/sessions");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/clubs");
    }

    private void NavigateToSession(TableRowClickEventArgs<Session> args)
    {
        var session = args.Item;
        if (session == null) return;
        var route = session.State switch
        {
            SessionState.Draft => $"/clubs/{ClubId}/sessions/{session.Id}/draft",
            SessionState.Active => $"/clubs/{ClubId}/sessions/{session.Id}/active",
            SessionState.Complete => $"/clubs/{ClubId}/sessions/{session.Id}/complete",
            _ => $"/clubs/{ClubId}/sessions"
        };
        Navigation.NavigateTo(route);
    }

    private async Task OpenEditDialog()
    {
        var parameters = new DialogParameters<ClubEditorDialog>
        {
            { x => x.Club, _club }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<ClubEditorDialog>("Edit Club", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            _club = await ClubService.GetByIdAsync(ClubId);
        }
    }
}
