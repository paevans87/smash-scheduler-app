@page "/clubs/{ClubId:guid}/sessions/{SessionId:guid}/active"
@using SmashScheduler.Application.Services.ClubManagement
@using SmashScheduler.Application.Services.SessionManagement
@using SmashScheduler.Application.Services.MatchManagement
@using SmashScheduler.Application.Services.Matchmaking
@using SmashScheduler.Application.Services.Matchmaking.Models
@using SmashScheduler.Domain.Entities
@using SmashScheduler.Domain.Enums
@using SmashScheduler.Domain.ValueObjects
@using SmashScheduler.Web.Services
@inject ISessionService SessionService
@inject ISessionStateManager SessionStateManager
@inject IMatchService MatchService
@inject IMatchmakingService MatchmakingService
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IBreadcrumbService BreadcrumbService
@inject IClubService ClubService

<PageTitle>Active Session</PageTitle>

@if (_session == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <div class="session-header d-flex align-center justify-space-between mb-4">
        <MudStack>
            <MudText Typo="Typo.h4" Class="d-none d-sm-block">Active Session</MudText>
            <MudText Typo="Typo.h5" Class="d-block d-sm-none">Active Session</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @_session.ScheduledDateTime.ToString("dd MMM yyyy HH:mm") â€¢ @_session.CourtCount courts
            </MudText>
        </MudStack>
        <div class="session-header-controls d-flex align-center gap-2">
            <SessionStateBadge State="@_session.State" Size="Size.Medium" />
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       Size="Size.Small"
                       OnClick="@EndSession">
                End Session
            </MudButton>
        </div>
    </div>

    <RealTimeStatsPanel Session="@_session"
                        Matches="@_activeMatches"
                        PlayerLookup="@_playerLookup" />

    <MatchmakingPanel Session="@_session"
                      ActiveMatches="@_activeMatches"
                      PlayerLookup="@_playerLookup"
                      GamesPlayedLookup="@GetGamesPlayedLookup()"
                      CanGenerateMatches="@CanGenerateMatches()"
                      OnGenerateMatches="GenerateMatches"
                      OnAddManualMatch="OpenManualMatchDialog"
                      OnCreateDraftMatch="OpenCreateDraftDialog"
                      OnAutoGenerateDraft="AutoGenerateDraft"
                      OnMatchComplete="CompleteMatch"
                      OnMatchPlayersUpdate="UpdateMatchPlayers"
                      OnStartDraftMatch="StartDraftMatch"
                      OnDeleteDraftMatch="DeleteDraftMatch" />
}

@code {
    [Parameter] public Guid ClubId { get; set; }
    [Parameter] public Guid SessionId { get; set; }

    private Session? _session;
    private List<Match> _activeMatches = new();
    private Dictionary<Guid, Player> _playerLookup = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        var club = await ClubService.GetByIdAsync(ClubId);

        var items = new List<BreadcrumbItem> {
            new("Home", "/"),
            new("Clubs", "/clubs"),
            new(club?.Name ?? "club", $"/clubs/{ClubId}"),
            new("Sessions", $"/clubs/{ClubId}/sessions")
        };
        BreadcrumbService.SetBreadcrumbs(items);
    }

    private async Task LoadData()
    {
        _session = await SessionService.GetByIdAsync(SessionId);
        if (_session != null)
        {
            _activeMatches = await MatchService.GetBySessionIdAsync(SessionId);
            _playerLookup = _session.SessionPlayers
                .Where(sp => sp.Player != null)
                .ToDictionary(sp => sp.PlayerId, sp => sp.Player!);
        }
    }

    private bool CanGenerateMatches()
    {
        if (_session == null) return false;
        var inProgressMatches = _activeMatches.Count(m => m.State == MatchState.InProgress);
        var availableCourts = _session.CourtCount - inProgressMatches;
        var benchedCount = GetBenchedPlayerCount();
        return availableCourts > 0 && benchedCount >= 4;
    }

    private int GetBenchedPlayerCount()
    {
        if (_session == null) return 0;
        var committedPlayerIds = _activeMatches
            .Where(m => m.State != MatchState.Completed)
            .SelectMany(m => m.PlayerIds)
            .ToHashSet();
        return _session.SessionPlayers
            .Count(sp => sp.IsActive && !committedPlayerIds.Contains(sp.PlayerId));
    }

    private async Task GenerateMatches()
    {
        if (_session == null) return;

        var usedCourts = _activeMatches
            .Where(m => m.State == MatchState.InProgress)
            .Select(m => m.CourtNumber)
            .ToHashSet();

        var allAvailableCourts = Enumerable.Range(1, _session.CourtCount)
            .Where(c => !usedCourts.Contains(c))
            .ToList();

        var optionsParams = new DialogParameters<GenerationOptionsDialog>
        {
            { x => x.AllCourts, allAvailableCourts },
            { x => x.CourtLabels, _session.CourtLabels }
        };

        var optionsDialogOptions = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraSmall,
            CloseOnEscapeKey = true
        };

        var optionsDialog = await DialogService.ShowAsync<GenerationOptionsDialog>("Generation Options", optionsParams, optionsDialogOptions);
        var optionsResult = await optionsDialog.Result;

        if (optionsResult is { Canceled: true } or null) return;

        var generationOptions = (GenerationOptions)optionsResult.Data!;

        var candidates = await MatchmakingService.GenerateMatchesAsync(SessionId, options: generationOptions);

        if (!candidates.Any())
        {
            candidates = GenerateFallbackMatches();
        }

        if (!candidates.Any())
        {
            return;
        }

        var parameters = new DialogParameters<MatchPreviewDialog>
        {
            { x => x.ProposedMatches, candidates },
            { x => x.PlayerLookup, _playerLookup },
            { x => x.SessionId, SessionId },
            { x => x.GenerationOptions, generationOptions }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<MatchPreviewDialog>("Confirm Matches", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: MatchPreviewResult previewResult })
        {
            foreach (var candidate in previewResult.Matches)
            {
                await MatchService.CreateMatchAsync(SessionId, candidate.CourtNumber, candidate.PlayerIds, true);
            }

            await LoadData();
            StateHasChanged();
        }
    }

    private List<MatchCandidate> GenerateFallbackMatches()
    {
        if (_session == null) return new List<MatchCandidate>();

        var committedPlayerIds = _activeMatches
            .Where(m => m.State != MatchState.Completed)
            .SelectMany(m => m.PlayerIds)
            .ToHashSet();

        var benchedPlayerIds = _session.SessionPlayers
            .Where(sp => sp.IsActive && !committedPlayerIds.Contains(sp.PlayerId))
            .Select(sp => sp.PlayerId)
            .ToList();

        var usedCourts = _activeMatches
            .Where(m => m.State == MatchState.InProgress)
            .Select(m => m.CourtNumber)
            .ToHashSet();

        var availableCourts = Enumerable.Range(1, _session.CourtCount)
            .Where(c => !usedCourts.Contains(c))
            .ToList();

        var candidates = new List<MatchCandidate>();
        var playerIndex = 0;

        foreach (var courtNumber in availableCourts)
        {
            if (playerIndex + 4 > benchedPlayerIds.Count) break;

            candidates.Add(new MatchCandidate
            {
                CourtNumber = courtNumber,
                PlayerIds = benchedPlayerIds.Skip(playerIndex).Take(4).ToList()
            });
            playerIndex += 4;
        }

        return candidates;
    }

    private async Task CompleteMatch((Guid MatchId, int? PreSelectedWinner) args)
    {
        var match = _activeMatches.FirstOrDefault(m => m.Id == args.MatchId);
        if (match == null) return;

        var parameters = new DialogParameters<MatchResultDialog>
        {
            { x => x.Match, match },
            { x => x.PlayerLookup, _playerLookup },
            { x => x.PreSelectedWinner, args.PreSelectedWinner }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<MatchResultDialog>("Save Match", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            var (score, winners) = ((MatchScore?, List<Guid>?))result.Data!;
            await MatchService.CompleteMatchAsync(args.MatchId, winners, score);
            await LoadData();
            StateHasChanged();
        }
    }

    private async Task UpdateMatchPlayers((Guid MatchId, List<Guid> PlayerIds) update)
    {
        await MatchService.UpdateMatchPlayersAsync(update.MatchId, update.PlayerIds);
        await LoadData();
        StateHasChanged();
    }

    private async Task StartDraftMatch((Guid MatchId, int CourtNumber) args)
    {
        await MatchService.StartDraftMatchAsync(args.MatchId, args.CourtNumber);
        await LoadData();
        StateHasChanged();
    }

    private async Task DeleteDraftMatch(Guid matchId)
    {
        await MatchService.DeleteMatchAsync(matchId);
        await LoadData();
        StateHasChanged();
    }

    private Dictionary<Guid, int> GetGamesPlayedLookup()
    {
        var lookup = new Dictionary<Guid, int>();
        var completedMatches = _activeMatches.Where(m => m.State == MatchState.Completed);

        foreach (var match in completedMatches)
        {
            foreach (var playerId in match.PlayerIds)
            {
                lookup.TryGetValue(playerId, out var count);
                lookup[playerId] = count + 1;
            }
        }

        return lookup;
    }

    private async Task OpenManualMatchDialog()
    {
        if (_session == null) return;

        var usedCourts = _activeMatches
            .Where(m => m.State == MatchState.InProgress)
            .Select(m => m.CourtNumber)
            .ToHashSet();

        var availableCourts = Enumerable.Range(1, _session.CourtCount)
            .Where(c => !usedCourts.Contains(c))
            .ToList();

        if (!availableCourts.Any()) return;

        var courtNumber = availableCourts.First();

        if (availableCourts.Count > 1)
        {
            var courtParams = new DialogParameters<CourtSelectionDialog>
            {
                { x => x.AvailableCourts, availableCourts },
                { x => x.CourtLabels, _session.CourtLabels }
            };

            var courtDialog = await DialogService.ShowAsync<CourtSelectionDialog>(
                "Select Court", courtParams, new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, CloseOnEscapeKey = true });
            var courtResult = await courtDialog.Result;

            if (courtResult is { Canceled: false, Data: int selectedCourt })
            {
                courtNumber = selectedCourt;
            }
            else
            {
                return;
            }
        }

        var committedPlayerIds = _activeMatches
            .Where(m => m.State != MatchState.Completed)
            .SelectMany(m => m.PlayerIds)
            .ToHashSet();

        var benchPlayerIds = _session.SessionPlayers
            .Where(sp => sp.IsActive && !committedPlayerIds.Contains(sp.PlayerId))
            .Select(sp => sp.PlayerId)
            .ToList();

        var parameters = new DialogParameters<ManualMatchDialog>
        {
            { x => x.CourtNumber, courtNumber },
            { x => x.PlayerLookup, _playerLookup },
            { x => x.BenchPlayerIds, benchPlayerIds },
            { x => x.SuggestedPlayerIds, new List<Guid>() }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ManualMatchDialog>("Create Match", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: ManualMatchResult manualResult })
        {
            await MatchService.CreateMatchAsync(SessionId, manualResult.CourtNumber, manualResult.PlayerIds, false);
            await LoadData();
            StateHasChanged();
        }
    }

    private async Task OpenCreateDraftDialog()
    {
        if (_session == null) return;

        var committedPlayerIds = _activeMatches
            .Where(m => m.State != MatchState.Completed)
            .SelectMany(m => m.PlayerIds)
            .ToHashSet();

        var benchPlayerIds = _session.SessionPlayers
            .Where(sp => sp.IsActive && !committedPlayerIds.Contains(sp.PlayerId))
            .Select(sp => sp.PlayerId)
            .ToList();

        var parameters = new DialogParameters<ManualMatchDialog>
        {
            { x => x.CourtNumber, 0 },
            { x => x.PlayerLookup, _playerLookup },
            { x => x.BenchPlayerIds, benchPlayerIds },
            { x => x.SuggestedPlayerIds, new List<Guid>() },
            { x => x.IsDraftMode, true }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ManualMatchDialog>("Create Draft", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: ManualMatchResult manualResult })
        {
            await MatchService.CreateDraftMatchAsync(SessionId, manualResult.PlayerIds);
            await LoadData();
            StateHasChanged();
        }
    }

    private async Task AutoGenerateDraft()
    {
        if (_session == null) return;

        var benchedCount = GetBenchedPlayerCount();
        var maxGames = benchedCount / 4;

        var optionsParams = new DialogParameters<GenerationOptionsDialog>
        {
            { x => x.AllCourts, new List<int>() },
            { x => x.CourtLabels, _session.CourtLabels },
            { x => x.ShowCourts, false },
            { x => x.MaxMatchCount, maxGames }
        };

        var optionsDialogOptions = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraSmall,
            CloseOnEscapeKey = true
        };

        var optionsDialog = await DialogService.ShowAsync<GenerationOptionsDialog>("Draft Options", optionsParams, optionsDialogOptions);
        var optionsResult = await optionsDialog.Result;

        if (optionsResult is { Canceled: true } or null) return;

        var generationOptions = (GenerationOptions)optionsResult.Data!;

        var candidates = await MatchmakingService.GenerateMatchesAsync(SessionId, options: generationOptions);

        if (!candidates.Any()) return;

        var parameters = new DialogParameters<MatchPreviewDialog>
        {
            { x => x.ProposedMatches, candidates },
            { x => x.PlayerLookup, _playerLookup },
            { x => x.SessionId, SessionId },
            { x => x.GenerationOptions, generationOptions },
            { x => x.IsDraftMode, true }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<MatchPreviewDialog>("Confirm Drafts", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: MatchPreviewResult previewResult })
        {
            foreach (var candidate in previewResult.Matches)
            {
                await MatchService.CreateDraftMatchAsync(SessionId, candidate.PlayerIds);
            }

            await LoadData();
            StateHasChanged();
        }
    }

    private async Task EndSession()
    {
        await SessionStateManager.CompleteSessionAsync(SessionId);
        Navigation.NavigateTo($"/clubs/{ClubId}/sessions/{SessionId}/complete");
    }
}
