@page "/clubs/{ClubId:guid}/sessions/{SessionId:guid}/complete"
@using SmashScheduler.Application.Services.ClubManagement
@using SmashScheduler.Application.Services.SessionManagement
@using SmashScheduler.Application.Services.MatchManagement
@using SmashScheduler.Domain.Entities
@using SmashScheduler.Domain.Enums
@using SmashScheduler.Web.Services
@inject ISessionService SessionService
@inject IMatchService MatchService
@inject NavigationManager Navigation
@inject IBreadcrumbService BreadcrumbService
@inject IClubService ClubService

<PageTitle>Session Complete</PageTitle>

@if (_session == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudStack>
            <MudText Typo="Typo.h4">Session Summary</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @_session.ScheduledDateTime.ToString("dd MMM yyyy HH:mm")
            </MudText>
        </MudStack>
        <SessionStateBadge State="@_session.State" Size="Size.Medium" />
    </MudStack>

    <MudGrid Class="mb-4">
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.h4" Color="Color.Primary">@_matches.Count</MudText>
                <MudText Typo="Typo.body2">Total Matches</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.h4" Color="Color.Success">@_matches.Count(m => m.State == MatchState.Completed)</MudText>
                <MudText Typo="Typo.body2">Completed</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.h4" Color="Color.Info">@_session.SessionPlayers.Count</MudText>
                <MudText Typo="Typo.body2">Players</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.h4" Color="Color.Secondary">@_session.CourtCount</MudText>
                <MudText Typo="Typo.body2">Courts</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudExpansionPanels>
        <MudExpansionPanel Expanded="false">
            <TitleContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.History" Color="Color.Primary" />
                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Match History</MudText>
                </MudStack>
            </TitleContent>
            <ChildContent>
                <MudGrid>
                    @foreach (var match in _matches.OrderBy(m => m.StartedAt))
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MatchCard Match="@match"
                                       PlayerLookup="@_playerLookup"
                                       IsReadOnly="true"
                                       ShowHeader="false" />
                        </MudItem>
                    }
                </MudGrid>
                @if (!_matches.Any())
                {
                    <MudText Typo="Typo.body1" Color="Color.Secondary">No matches were played in this session.</MudText>
                }
            </ChildContent>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <MudStack Row="true" Spacing="2" Class="mt-4">
        <MudButton Variant="Variant.Outlined" OnClick="@GoBack">Back to Sessions</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="@ViewAnalytics">
            View Analytics
        </MudButton>
    </MudStack>
}

@code {
    [Parameter] public Guid ClubId { get; set; }
    [Parameter] public Guid SessionId { get; set; }

    private Session? _session;
    private List<Match> _matches = new();
    private Dictionary<Guid, Player> _playerLookup = new();

    protected override async Task OnInitializedAsync()
    {
        _session = await SessionService.GetByIdAsync(SessionId);
        if (_session != null)
        {
            _matches = await MatchService.GetBySessionIdAsync(SessionId);
            _playerLookup = _session.SessionPlayers
                .Where(sp => sp.Player != null)
                .ToDictionary(sp => sp.PlayerId, sp => sp.Player!);
        }
        
        var club = await ClubService.GetByIdAsync(ClubId);
        
        var items = new List<BreadcrumbItem> { 
            new("Home", "/"), 
            new("Clubs", "/clubs"),
            new(club?.Name ?? "club", $"/clubs/{ClubId}"),
            new("Sessions", $"/clubs/{ClubId}/sessions")
        };
        BreadcrumbService.SetBreadcrumbs(items);
    }

    private void GoBack()
    {
        Navigation.NavigateTo($"/clubs/{ClubId}/sessions");
    }

    private void ViewAnalytics()
    {
        Navigation.NavigateTo($"/clubs/{ClubId}/sessions/{SessionId}/analytics");
    }
}
