@page "/clubs/{ClubId:guid}/sessions/{SessionId:guid}/draft"
@using SmashScheduler.Application.Services.SessionManagement
@using SmashScheduler.Application.Services.PlayerManagement
@using SmashScheduler.Domain.Entities
@inject ISessionService SessionService
@inject ISessionStateManager SessionStateManager
@inject IPlayerService PlayerService
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Session Draft</PageTitle>

@if (_session == null || _allPlayers == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudStack>
            <MudText Typo="Typo.h4">Session Draft</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @_session.ScheduledDateTime.ToString("dd MMM yyyy HH:mm")
            </MudText>
        </MudStack>
        <SessionStateBadge State="@_session.State" Size="Size.Medium" />
    </MudStack>

    <MudPaper Class="pa-3 mb-4" Elevation="1">
        <MudStack Row="true" Spacing="4" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
            <MudDatePicker Label="Date"
                           @bind-Date="_selectedDate"
                           DateFormat="dd MMM yyyy"
                           Variant="Variant.Outlined"
                           PickerVariant="PickerVariant.Dialog"
                           Style="min-width: 180px;" />
            <MudTimePicker Label="Time"
                           @bind-Time="_selectedTime"
                           Variant="Variant.Outlined"
                           PickerVariant="PickerVariant.Dialog"
                           Style="min-width: 140px;" />
            <MudNumericField T="int"
                             Label="Courts"
                             @bind-Value="_session.CourtCount"
                             Min="1"
                             Max="10"
                             Variant="Variant.Outlined"
                             Style="min-width: 100px;" />
            <MudText Typo="Typo.body1">
                <b>@GetSessionPlayerCount()</b> players in session
            </MudText>
        </MudStack>

        <MudExpansionPanels Class="mt-3" Elevation="0">
            <MudExpansionPanel Text="Custom Court Names" Dense="true">
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                    Optionally set custom names for courts (e.g., "Court 7" instead of "Court 1")
                </MudText>
                <MudStack Spacing="2">
                    @for (var i = 1; i <= _session.CourtCount; i++)
                    {
                        var courtNum = i;
                        <MudTextField T="string"
                                      Label="@($"Court {courtNum}")"
                                      Value="@GetCourtLabel(courtNum)"
                                      ValueChanged="@(value => SetCourtLabel(courtNum, value))"
                                      Placeholder="@($"Court {courtNum}")"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense" />
                    }
                </MudStack>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </MudPaper>

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.h6" GutterBottom="true">Available Players (@GetAvailablePlayers().Count())</MudText>
                <MudTextField T="string"
                              @bind-Value="_playerSearchText"
                              Placeholder="Search players..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              Clearable="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Class="mb-2" />
                <MudStack Spacing="1">
                    @foreach (var player in GetAvailablePlayers())
                    {
                        <PlayerCard Player="@player"
                                    ShowActions="true"
                                    OnAdd="@(() => AddPlayerToSession(player))" />
                    }
                    @if (!GetAvailablePlayers().Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">All players added to session</MudText>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.h6" GutterBottom="true">Session Players (@GetSessionPlayerCount())</MudText>
                <MudStack Spacing="1">
                    @foreach (var sessionPlayer in _session.SessionPlayers)
                    {
                        @if (sessionPlayer.Player != null)
                        {
                            <PlayerCard Player="@sessionPlayer.Player"
                                        ShowActions="true"
                                        OnRemove="@(() => RemovePlayerFromSession(sessionPlayer.Player))" />
                        }
                    }
                    @if (!_session.SessionPlayers.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No players added yet</MudText>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudStack Row="true" Spacing="2" Class="mt-4" Justify="Justify.SpaceBetween">
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Error"
                   StartIcon="@Icons.Material.Filled.Delete"
                   OnClick="AbandonDraft">
            Abandon Draft
        </MudButton>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" OnClick="GoBack">Back</MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@(!CanStartSession())"
                       OnClick="StartSession">
                Create Session (@GetSessionPlayerCount() players)
            </MudButton>
        </MudStack>
    </MudStack>

    @if (!CanStartSession())
    {
        <MudAlert Severity="Severity.Info" Class="mt-2">
            You need at least 4 players to start a session.
        </MudAlert>
    }
}

@code {
    [Parameter] public Guid ClubId { get; set; }
    [Parameter] public Guid SessionId { get; set; }

    private Session? _session;
    private List<Player>? _allPlayers;
    private string? _playerSearchText;

    private DateTime? _selectedDate
    {
        get => _session?.ScheduledDateTime.Date;
        set
        {
            if (_session != null && value.HasValue)
            {
                var time = _session.ScheduledDateTime.TimeOfDay;
                _session.ScheduledDateTime = value.Value.Date + time;
            }
        }
    }

    private TimeSpan? _selectedTime
    {
        get => _session?.ScheduledDateTime.TimeOfDay;
        set
        {
            if (_session != null && value.HasValue)
            {
                var date = _session.ScheduledDateTime.Date;
                _session.ScheduledDateTime = date + value.Value;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _session = await SessionService.GetByIdAsync(SessionId);
        _allPlayers = await PlayerService.GetByClubIdAsync(ClubId);
    }

    private IEnumerable<Player> GetAvailablePlayers()
    {
        if (_allPlayers == null || _session == null) return Enumerable.Empty<Player>();
        var sessionPlayerIds = _session.SessionPlayers.Select(sp => sp.PlayerId).ToHashSet();
        var available = _allPlayers.Where(p => !sessionPlayerIds.Contains(p.Id));
        if (!string.IsNullOrWhiteSpace(_playerSearchText))
        {
            available = available.Where(p => p.Name.Contains(_playerSearchText, StringComparison.OrdinalIgnoreCase));
        }
        return available;
    }

    private int GetSessionPlayerCount() => _session?.SessionPlayers.Count ?? 0;

    private bool CanStartSession() => GetSessionPlayerCount() >= 4;

    private async Task AddPlayerToSession(Player player)
    {
        await SessionService.AddPlayerToSessionAsync(SessionId, player.Id);
        await LoadData();
    }

    private async Task RemovePlayerFromSession(Player player)
    {
        await SessionService.RemovePlayerFromSessionAsync(SessionId, player.Id);
        await LoadData();
    }

    private async Task StartSession()
    {
        if (_session != null)
        {
            await SessionService.UpdateSessionAsync(_session);
        }
        await SessionStateManager.ActivateSessionAsync(SessionId);
        Navigation.NavigateTo($"/clubs/{ClubId}/sessions/{SessionId}/active");
    }

    private async Task AbandonDraft()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Abandon Draft",
            "Are you sure you want to abandon this draft? This action cannot be undone.",
            yesText: "Abandon",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            await SessionService.DeleteSessionAsync(SessionId);
            Navigation.NavigateTo($"/clubs/{ClubId}/sessions");
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo($"/clubs/{ClubId}/sessions");
    }

    private string GetCourtLabel(int courtNumber)
    {
        if (_session == null) return string.Empty;
        return _session.CourtLabels.TryGetValue(courtNumber, out var label) ? label : string.Empty;
    }

    private void SetCourtLabel(int courtNumber, string? value)
    {
        if (_session == null) return;
        var labels = _session.CourtLabels;
        if (string.IsNullOrWhiteSpace(value))
        {
            labels.Remove(courtNumber);
        }
        else
        {
            labels[courtNumber] = value;
        }
        _session.CourtLabels = labels;
    }
}
